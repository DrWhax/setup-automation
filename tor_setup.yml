- hosts: all
  port: 22023
  remote_user: johannes
  sudo: yes
  tasks:
      - name: Add pycurl package
        apt: pkg=python-pycurl state=present
 
      - name: Add Tor repository
        apt_repository: repo="deb http://deb.torproject.org/torproject.org wheezy main" state=present

      - name: Add Tor Keyservers
        shell: apt-key adv --recv-keys --keyserver keys.gnupg.net 886DDD89

      - name: Install Torproject Keyring
        apt: update_cache=yes install_recommends=no pkg=deb.torproject.org-keyring state=present

      - name: Install Tor geoip database
        apt: update_cache=yes install_recommends=no pkg={{item}}
        with_items:
            - tor
            - tor-geoipdb

            
      # -- snip -- for later on tor deployment of torrc-generator

      - name: Stop tor for maintenance
        service: name=tor state=stopped

      - name: Add torservers torrc
        template: src=config/torrc dest=/etc/tor/torrc 

      - name: Restart Relay
        service: name=tor state=started

      - name: Install unbound DNS Server
        apt: pkg=unbound state=installed
        
      # -- snap for later on deployment of torrc-generator
        
      - name: Create directories for tor's controlport statements and auth cookies
        file: path={{ item }} owner=debian-tor group=debian-tor mode=640 state=directory
        with_items:
          - /var/run/torctl/statements
          - /var/run/torctl/cookies

      - name: Activate unbound DNS Server
        shell: echo "nameserver 127.0.0.1" > /etc/resolv.conf

      #
      # Install Munin Node
      #
      
      - name: Install munin node
        apt: pkg=munin-node state=present

      - name: Enable netstat plugin for munin
        file: src=/usr/share/munin/plugins/netstat dest=/etc/munin/plugins/netstat state=link
        
      - name: Remove http_loadtime plugin from munin
        file: path=/etc/munin/plugins/http_loadtime state=absent
 
      - name: Remove ntp plugins from munin
        file: path={{item}} state=absent
        with_fileglob: /etc/munin/plugins/ntp_* 
          
      - name: Remove postfix plugins from munin
        file: path={{item}} state=absent
        with_fileglob: /etc/munin/plugins/postfix_* 
 
      - name: Remove exim plugins from munin
        file: path={{item}} state=absent
        with_fileglob: /etc/munin/plugins/exim_* 
 
      - name: Allow torserver.net's munin collector
        shell: sed "s/allow \\^127\\\.0\\\.0\\\.1\\$/allow ^194\\\.150\\\.168\\\.61$/" -i /etc/munin/munin-node.conf

      - name: restart munin node
        service: name=munin-node state=restarted